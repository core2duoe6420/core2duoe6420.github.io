<!doctype html><html lang=en-us><head><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"autotools Tinkering Notes","datePublished":"2014-10-10T00:00:00Z","dateModified":"2014-10-10T00:00:00Z","author":{"@type":"Person","name":"Alex King","image":"https://res.cloudinary.com/core2duoe6420/image/upload/v1643906248/DSC_5117_wviusa.jpg"},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.hljin.net\/en-us\/2014\/10\/autotools-play\/"},"publisher":{"@type":"Organization","name":"Alex King's blog","logo":{"@type":"ImageObject","url":"https://res.cloudinary.com/core2duoe6420/image/upload/v1643906248/DSC_5117_wviusa.jpg"}},"description":" This article is translated from Chinese to English by ChatGPT. There might be errors.\nIt’s time again for that painful-yet-joyful tinkering, and this time the target is autotools. Back in the day I used to admire the configure and Makefile files in various open-source projects. I naively thought they were all handwritten by the project authors themselves, and I was full of awe for people in the open-source community. I couldn’t even understand them, let alone write them. Later I learned there is something called autoconf that can automatically generate these scripts. You still have to write some bits yourself, but it’s nowhere near as crazy as I had imagined.\n","keywords":[]}</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.111.3 with theme Tranquilpeak 0.5.3-BETA"><meta name=author content="Alex King"><meta name=keywords content><meta name=description content="
  This article is translated from Chinese to English by ChatGPT. There might be errors.

It’s time again for that painful-yet-joyful tinkering, and this time the target is autotools. Back in the day I used to admire the configure and Makefile files in various open-source projects. I naively thought they were all handwritten by the project authors themselves, and I was full of awe for people in the open-source community. I couldn’t even understand them, let alone write them. Later I learned there is something called autoconf that can automatically generate these scripts. You still have to write some bits yourself, but it’s nowhere near as crazy as I had imagined."><meta property="og:description" content="
  This article is translated from Chinese to English by ChatGPT. There might be errors.

It’s time again for that painful-yet-joyful tinkering, and this time the target is autotools. Back in the day I used to admire the configure and Makefile files in various open-source projects. I naively thought they were all handwritten by the project authors themselves, and I was full of awe for people in the open-source community. I couldn’t even understand them, let alone write them. Later I learned there is something called autoconf that can automatically generate these scripts. You still have to write some bits yourself, but it’s nowhere near as crazy as I had imagined."><meta property="og:type" content="article"><meta property="og:title" content="autotools Tinkering Notes"><meta name=twitter:title content="autotools Tinkering Notes"><meta property="og:url" content="https://blog.hljin.net/en-us/2014/10/autotools-play/"><meta property="twitter:url" content="https://blog.hljin.net/en-us/2014/10/autotools-play/"><meta property="og:site_name" content="Alex King's blog"><meta property="og:description" content="
  This article is translated from Chinese to English by ChatGPT. There might be errors.

It’s time again for that painful-yet-joyful tinkering, and this time the target is autotools. Back in the day I used to admire the configure and Makefile files in various open-source projects. I naively thought they were all handwritten by the project authors themselves, and I was full of awe for people in the open-source community. I couldn’t even understand them, let alone write them. Later I learned there is something called autoconf that can automatically generate these scripts. You still have to write some bits yourself, but it’s nowhere near as crazy as I had imagined."><meta name=twitter:description content="
  This article is translated from Chinese to English by ChatGPT. There might be errors.

It’s time again for that painful-yet-joyful tinkering, and this time the target is autotools. Back in the day I used to admire the configure and Makefile files in various open-source projects. I naively thought they were all handwritten by the project authors themselves, and I was full of awe for people in the open-source community. I couldn’t even understand them, let alone write them. Later I learned there is something called autoconf that can automatically generate these scripts. You still have to write some bits yourself, but it’s nowhere near as crazy as I had imagined."><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2014-10-10T00:00:00"><meta property="article:modified_time" content="2014-10-10T00:00:00"><meta name=twitter:card content="summary"><meta property="og:image" content="https://res.cloudinary.com/core2duoe6420/image/upload/v1643906248/DSC_5117_wviusa.jpg"><meta property="twitter:image" content="https://res.cloudinary.com/core2duoe6420/image/upload/v1643906248/DSC_5117_wviusa.jpg"><title>autotools Tinkering Notes</title><link rel=icon href=https://blog.hljin.net/favicon.png><link rel=canonical href=https://blog.hljin.net/en-us/2014/10/autotools-play/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.css integrity="sha512-MLcK/YRapzET1qTBXrOiZE6bGBgtATMo2bIyalVJ8EKDEGNoeA3SPQkvWAR0zNS650YG13ocXBMeioDuZcSRuQ==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://blog.hljin.net/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css><link rel=stylesheet href=https://blog.hljin.net/css/override.css></head><body><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=https://blog.hljin.net/en-us/ aria-label="Go to homepage">Alex King's blog</a></div><a class=header-right-picture href=https://blog.hljin.net/#about aria-label="Open the link: /#about"><img class=header-picture src=https://res.cloudinary.com/core2duoe6420/image/upload/v1643906248/DSC_5117_wviusa.jpg alt="Author's picture"></a></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=https://blog.hljin.net/#about aria-label="Read more about the author"><img class=sidebar-profile-picture src=https://res.cloudinary.com/core2duoe6420/image/upload/v1643906248/DSC_5117_wviusa.jpg alt="Author's picture"></a><h4 class=sidebar-profile-name>Alex King</h4><h5 class=sidebar-profile-bio>Observing without evaluating is the highest form of human intelligence</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://blog.hljin.net/en-us/ title=Home><i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden=true></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.hljin.net/en-us/categories title=Categories><i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden=true></i>
<span class=sidebar-button-desc>Categories</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.hljin.net/en-us/tags title=Tags><i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden=true></i>
<span class=sidebar-button-desc>Tags</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://blog.hljin.net/en-us/archives title=Archives><i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden=true></i>
<span class=sidebar-button-desc>Archives</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://blog.hljin.net/en-us/#about title=About><i class="sidebar-button-icon fas fa-lg fa-user" aria-hidden=true></i>
<span class=sidebar-button-desc>About</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/core2duoe6420 target=_blank rel=noopener title=GitHub><i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden=true></i>
<span class=sidebar-button-desc>GitHub</span></a></li></ul><ul class=sidebar-buttons></ul></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post id=top><div class="post-header main-content-wrap text-left"><h1 class=post-title>autotools Tinkering Notes</h1><div class="postShorten-meta post-meta"><time datetime=2014-10-10T00:00:00Z>October 10, 2014</time></div></div><div class="post-content markdown"><div class=main-content-wrap><div class="alert warning"><p>This article is translated from Chinese to English by ChatGPT. There might be errors.</p></div><p>It’s time again for that painful-yet-joyful tinkering, and this time the target is autotools. Back in the day I used to admire the <code>configure</code> and <code>Makefile</code> files in various open-source projects. I naively thought they were all handwritten by the project authors themselves, and I was full of awe for people in the open-source community. I couldn’t even understand them, let alone write them. Later I learned there is something called <code>autoconf</code> that can automatically generate these scripts. You still have to write some bits yourself, but it’s nowhere near as crazy as I had imagined.</p><p>However, the learning cost of this thing is really not low. First, there’s little Chinese documentation, and my poor English makes reading English docs exhausting. On top of that, the GNU manuals are like dictionaries rather than tutorials; if you’re starting from zero it’s basically impossible to understand them. I also didn’t have much motivation back then, so I never really dug into it.</p><h2 id=requirements-show-up>Requirements show up</h2><p>Now the motivation is here. Some time ago my advisor told me that for the current project, the part I’m responsible for needs to be submitted, while the more technically challenging and core part by my senior will be used only for demonstration. Since it’s going to be submitted, it has to look decent and “formal”. So I started thinking: what counts as “formal”? Those crappy hand-written Makefiles I had before look low-end at first glance. Obviously I needed a big pile of “fancy” files in the directory like <code>configue.ac Makefile.am Makefile.in</code>, and only with the classic three-step build <code>./configure && make && make install</code> could it be considered formal. So I started messing with autotools, and sticking to the “requirement-first” principle, I don’t intend to fully understand it. Really mastering this stuff is too complicated; I can only look things up when I need them, learn a bit at a time, and accumulate slowly. I genuinely admire those who can sit down and digest all of this, mastering every piece.</p><p>OK, enough chatter, let’s talk about the requirements and the general environment.</p><ul><li>The code uses two libraries, <code>libpcap</code> and <code>libdnet</code>. I added a function to the <code>libdnet</code> library to satisfy the program’s needs, so during configure we must check for the presence of both libraries and the new function, and report an error if they are missing.</li><li>The code uses a DEBUG macro, with the value of DEBUG indicating the debug level. <code>configure</code> must provide an option to configure the debug level.</li><li>For various reasons I implemented my own hash table, but I also adapted <code>glib</code>’s <code>GHashTable</code> into the code, controlled via a macro switch. <code>configure</code> needs to correctly handle the macro definition.</li></ul><p>Just these three items, which are actually quite simple, and autotools macros already cover these features. The program’s directory structure is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>--root              root directory
</span></span><span style=display:flex><span>  |--include        header files .h
</span></span><span style=display:flex><span>  |--src            source files .c
</span></span></code></pre></div><h2 id=autotools-tools-and-files>autotools tools and files</h2><p>Here “autotools” actually refers to a set of tools. To use autotools, you have to first clarify the relationships between these tools and the files they generate.</p><ul><li><code>autoconf</code>: generates <code>configure</code> from <code>configure.ac</code>. <code>configure.ac</code> is the most important file in the whole process.</li><li><code>autoheader</code>: generates <code>config.h.in</code> from <code>configure.ac</code>. <code>config.h.in</code> is the template for <code>config.h</code>; <code>config.h</code> contains all the macro definitions used by the program.</li><li><code>autoscan</code>: scans the source files and suggests some common portability checks and macro definitions.</li><li><code>autoreconf</code>: runs the various tools in the correct order, including <code>autoconf</code>, <code>autoheader</code>, <code>automake</code>.</li><li><code>automake</code>: generates <code>Makefile</code> from <code>configure.ac</code> and <code>Makefile.in</code>.</li></ul><p>There are also some lower-level tools that simple programs like this don’t need. Briefly:</p><ul><li><code>autom4te</code>: this is the core of the entire autotools toolchain. <code>autoconf</code> is essentially a set of M4 macros, and <code>autom4te</code> is the macro processor. Roughly, you can think of it as something like the preprocessing stage before C compilation.</li><li><code>aclocal</code>: generates <code>aclocal.m4</code>, which contains various custom macros.</li></ul><p>In fact, because my requirements are simple enough, after writing the necessary <code>configure.ac</code>, <code>Makefile.am</code>, and <code>src/Makefile.am</code>, I only need to run this one command to generate all required files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>autoreconf --install
</span></span></code></pre></div><p>This frees me from the complexity of these tools so I can focus on the core file <code>configure.ac</code>.</p><h2 id=writing-configureac>Writing configure.ac</h2><p><code>configure.ac</code> consists of a series of macros that are expanded by <code>autoconf</code>. These macro names follow conventional rules: those starting with <code>AC_</code> are <code>autoconf</code> macros, mainly used to generate the <code>configure</code> file; those starting with <code>AM_</code> are <code>automake</code> macros, mainly effective when generating <code>Makefile.in</code> together with <code>Makefile.am</code>. I’ll only introduce the macros I use. Macro parameters are wrapped in <code>[]</code>, which protects the argument strings from further expansion by the macro processor; this is a feature of M4 macros and I won’t go into detail here.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AC_INIT<span style=color:#f92672>([</span>convertor<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>0.1<span style=color:#f92672>])</span>
</span></span></code></pre></div><p>Initializes <code>autoconf</code>. The arguments are the software name and version number; there’s another parameter for the bug-reporting email address, which I did not provide. The information provided here will be written into <code>config.h.in</code> as <code>PACKAGE_xxx</code> macros.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AM_INIT_AUTOMAKE<span style=color:#f92672>([</span>foreign<span style=color:#f92672>])</span>
</span></span></code></pre></div><p>This initializes <code>automake</code>. <code>autoconf</code> can be used on its own, but to generate <code>Makefile</code> you must use it together with <code>automake</code>. One thing to note is that many online resources show this macro with three parameters, matching the earlier arguments of <code>AC_INIT</code>; that’s the old version and no longer applies to newer versions. Passing <code>foreign</code> enables the “foreign” mode. In GNU mode, <code>automake</code> requires files such as <code>NEWS</code>, <code>README</code>, <code>ChangeLog</code>, etc. Since I don’t have these files, I use foreign mode to disable those checks.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AC_CONFIG_SRCDIR<span style=color:#f92672>([</span>src/ip.c<span style=color:#f92672>])</span>
</span></span></code></pre></div><p>This macro checks whether <code>configure</code> is being run in the correct directory by testing the existence of some source file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AC_PROG_CC
</span></span></code></pre></div><p>This macro checks for the <code>gcc</code> program. <code>AC_PROG_xxx</code> macros are used to check whether the corresponding tools exist and work properly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AC_CHECK_LIB<span style=color:#f92672>([</span>dnet<span style=color:#f92672>]</span>, <span style=color:#f92672>[</span>eth_send_iovec<span style=color:#f92672>]</span>, <span style=color:#f92672>[]</span>, <span style=color:#f92672>[</span>AC_MSG_ERROR<span style=color:#f92672>([</span>libdnet not found or patched.<span style=color:#f92672>])])</span>
</span></span><span style=display:flex><span>AC_CHECK_LIB<span style=color:#f92672>([</span>pcap<span style=color:#f92672>]</span>, <span style=color:#f92672>[</span>pcap_open_live<span style=color:#f92672>]</span>, <span style=color:#f92672>[]</span>, <span style=color:#f92672>[</span>AC_MSG_ERROR<span style=color:#f92672>([</span>libpcap not found.<span style=color:#f92672>])])</span>
</span></span></code></pre></div><p>The <code>AC_CHECK_LIB</code> macro checks whether a dependency library exists by trying to compile against a function from that library. The function name is given by the second parameter. The third parameter is shell code to execute if the check succeeds, and the last parameter is shell code if the check fails. On failure I call the <code>AC_MSG_ERROR</code> macro, which prints an error and exits. There is also <code>AC_MSG_WARN</code>, which only prints a warning and continues. Since a function name is used to test for the presence of a library, I simply used the function I added to <code>libdnet</code> as the argument, which directly satisfies the first requirement.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AC_ARG_ENABLE<span style=color:#f92672>([</span>debug<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span>AS_HELP_STRING<span style=color:#f92672>([</span>--enable-debug<span style=color:#f92672>[=</span>level<span style=color:#f92672>]]</span>,<span style=color:#f92672>[</span>运行时打印调试信息（默认关闭）<span style=color:#f92672>])]</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> test <span style=color:#e6db74>&#34;x</span>$enableval<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;xyes&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            AC_DEFINE<span style=color:#f92672>([</span>DEBUG<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>Define <span style=color:#66d9ef>if</span> --enable-debug<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> test <span style=color:#e6db74>&#34;x</span>$enableval<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x0&#34;</span> ; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            AC_DEFINE<span style=color:#f92672>([</span>DEBUG<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>Define <span style=color:#66d9ef>if</span> --enable-debug<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> test <span style=color:#e6db74>&#34;x</span>$enableval<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x1&#34;</span> ; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            AC_DEFINE<span style=color:#f92672>([</span>DEBUG<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>Define <span style=color:#66d9ef>if</span> --enable-debug<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> test <span style=color:#e6db74>&#34;x</span>$enableval<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x2&#34;</span> ; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            AC_DEFINE<span style=color:#f92672>([</span>DEBUG<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>Define <span style=color:#66d9ef>if</span> --enable-debug<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> test <span style=color:#e6db74>&#34;x</span>$enableval<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x3&#34;</span> ; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            AC_DEFINE<span style=color:#f92672>([</span>DEBUG<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>Define <span style=color:#66d9ef>if</span> --enable-debug<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;Error! Unknown DEBUG level&#34;</span>
</span></span><span style=display:flex><span>            exit -1
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>This part serves the second requirement. Options defined by <code>AC_ARG_ENABLE</code> can be set when running <code>./configure</code> using <code>--enable-xxx[=value]</code>. It has four parameters: the first is the option name; the second is the help string, which can be viewed with <code>./configure --help</code>; the third is the script executed when this option is specified; the fourth is the script executed when the option is not specified. Note that both <code>--enable-xxx</code> and the corresponding <code>--disable-xxx</code> will run the third script; the difference is that <code>$enableval</code> is <code>yes</code> or <code>no</code>. If a <code>=val</code> is provided, then <code>$enableval</code> is set to <code>val</code>. Finally, the <code>AC_DEFINE</code> macro writes the specified value into <code>config.h.in</code>, in the form <code>AC_DEFINE([name],[value],[note])</code>, which becomes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* note */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define name value
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AC_ARG_WITH<span style=color:#f92672>([</span>glib<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span>AS_HELP_STRING<span style=color:#f92672>([</span>--with-glib<span style=color:#f92672>]</span>, <span style=color:#f92672>[</span>使用glib中的HashTable（默认关闭）<span style=color:#f92672>])]</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> test <span style=color:#e6db74>&#34;x</span>$withval<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;xyes&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            AC_DEFINE<span style=color:#f92672>([</span>_USING_GLIB_HASHTABLE<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>,<span style=color:#f92672>[</span>Define <span style=color:#66d9ef>if</span> --with-glib<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>            PKG_CHECK_MODULES<span style=color:#f92672>([</span>GLIB<span style=color:#f92672>]</span>, <span style=color:#f92672>[</span>glib-2.0<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>            with_glib<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;yes&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>AM_CONDITIONAL<span style=color:#f92672>([</span>USE_GLIB<span style=color:#f92672>]</span>, <span style=color:#f92672>[</span>test <span style=color:#e6db74>&#34;x</span>$with_glib<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;xyes&#34;</span><span style=color:#f92672>])</span>
</span></span></code></pre></div><p>This part serves the third requirement. <code>AC_ARG_WITH</code> is very similar to <code>AC_ARG_ENABLE</code>, but is specified via <code>--with-xxx</code>. The parameters work the same way. The <code>PKG_CHECK_MODULES</code> macro uses <code>pkg-config</code> to obtain compilation and linking options for a library. According to the arguments, its effect is roughly equivalent to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>GLIB_CFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>pkg-config --cflags glib-2.0<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>GLIB_LIBS<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>pkg-config --libs glib-2.0<span style=color:#e6db74>`</span>
</span></span></code></pre></div><p>The two variables <code>GLIB_CFLAGS</code> and <code>GLIB_LIBS</code> will be used when writing <code>Makefile.am</code>. Finally, <code>AM_CONDITIONAL</code> sets a conditional variable: it evaluates the second argument and, if true, sets the first argument to <code>TRUE</code>, and to <code>FALSE</code> otherwise. The value defined here is also used in <code>Makefile.am</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>AC_CONFIG_HEADERS<span style=color:#f92672>([</span>config.h<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>AC_CONFIG_FILES<span style=color:#f92672>([</span>Makefile src/Makefile<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>AC_OUTPUT
</span></span></code></pre></div><p>These last three lines specify the output files generated after running <code>./configure</code>. Note that every subdirectory must have a Makefile. At this point, <code>configure.ac</code> is done.</p><h2 id=writing-makefileam>Writing Makefile.am</h2><p>We need to write two <code>Makefile.am</code> files. The first one is in the root directory and is very simple, just one line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>SUBDIRS <span style=color:#f92672>=</span> src
</span></span></code></pre></div><p>This specifies which subdirectories to recurse into. Here there is only one, but you can specify many, separated by spaces, and each subdirectory must have its own <code>Makefile.am</code>.</p><p>The second <code>Makefile.am</code> is of course in the <code>src</code> directory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bin_PROGRAMS <span style=color:#f92672>=</span> convertor
</span></span><span style=display:flex><span>convertor_CFLAGS <span style=color:#f92672>=</span> -std<span style=color:#f92672>=</span>gnu99 -I<span style=color:#66d9ef>$(</span>srcdir<span style=color:#66d9ef>)</span>/../include -O
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> USE_GLIB
</span></span><span style=display:flex><span>    convertor_CFLAGS <span style=color:#f92672>+=</span> <span style=color:#66d9ef>$(</span>GLIB_CFLAGS<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>endif
</span></span><span style=display:flex><span>convertor_LDFLAGS <span style=color:#f92672>=</span> -pthread
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> USE_GLIB
</span></span><span style=display:flex><span>    convertor_LDADD <span style=color:#f92672>=</span> <span style=color:#66d9ef>$(</span>GLIB_LIBS<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>endif
</span></span><span style=display:flex><span><span style=color:#75715e>#convertor_LDADD = -ldnet -lpcap</span>
</span></span><span style=display:flex><span>convertor_SOURCES <span style=color:#f92672>=</span> a.c b.c c.c
</span></span></code></pre></div><p>This piece is quite concise and easy to understand, but a few points are worth noting:</p><ul><li>In <code>bin_PROGRAMS</code>, <code>bin</code> means the program will be installed under <code>${exec_prefix}/bin</code> by <code>make install</code>. <code>${exec_prefix}</code> is a variable preset by <code>autoconf</code>; by default it equals <code>${prefix}</code>. There are many similar ones: for example, with <code>lib</code> the files will be installed under <code>${exec_prefix}/lib</code>, while <code>noinst</code> means they are not installed. <code>PROGRAMS</code> indicates the target is an executable; similarly there are <code>LIBRARIES</code> for libraries, <code>HEADERS</code> for header files, and so on. I don’t use these here and haven’t experimented further.</li><li>After specifying the target name with the first line, you can use <code>name_CFLAGS</code>, <code>name_LDFLAGS</code>, <code>name_SOURCES</code>, etc. to set per-target variables. Some of these have corresponding global values shared by all targets, such as <code>AM_CFLAGS</code>, <code>AM_LDFLAGS</code>.</li><li><code>LDADD</code> is specifically used to add the required libraries. Libraries specified in <code>LDADD</code> are placed at the end of the gcc link command to ensure correct linking (if they are placed in <code>LDFLAGS</code>, they may appear before the <code>.o</code> files in the gcc link command and fail to link correctly). The global version of <code>LDADD</code> is just <code>LDADD</code> (without the <code>AM_</code> prefix). In addition, libraries checked via <code>AC_CHECK_LIB</code> in <code>configure.ac</code> are automatically added to the compile command, so they don’t need to be set separately; you can see that the line in the code is commented out.</li><li>Here you can also see how <code>USE_GLIB</code>, <code>GLIB_CFLAGS</code>, and <code>GLIB_LIBS</code> defined in <code>configure.ac</code> are used; it’s quite straightforward, so I won’t say more.</li></ul><h2 id=references>References</h2><p>Once the two files are written, you can run <code>autoreconf --install</code> to generate all necessary files, and then build and install like the most common programs using <code>./configure && make && make install</code>.</p><p>Finally, here are the materials I referenced during my tinkering:</p><ul><li>First is what I consider the most valuable introductory material. It’s like a set of PPT slides but published as a PDF. There are 162 PPT slides, but each animation step is split into a separate page, so the PDF shows 556 pages. It scared me at first, but it turned out to be fine. I basically learned by following this PDF. Here is the <a href=https://www.lrde.epita.fr/~adl/autotools.html>download link</a>.</li><li>The <a href=http://www.gnu.org/software/autoconf/manual/autoconf.html>Autoconf Manual</a> is unavoidable.</li><li><a href=http://dl.e-book-free.com/2013/07/autotools.pdf>“AUTOTOOLS: A PRACTITIONER&rsquo;S GUIDE TO GNU AUTOCONF, AUTOMAKE, AND LIBTOOL”</a> is more serious: a three-hundred-plus-page book, but more systematic.</li><li>Various blogs on the web, for example <a href=http://blog.csdn.net/scucj/article/details/6079052>this one</a>. Autotools documentation in Chinese is really scarce, and much of what’s online is outdated. To really learn it, you have to read English, which is quite painful.</li></ul></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.hljin.net/en-us/2014/10/compile-wireshark/ data-tooltip="Compiling Wireshark on Windows" aria-label="NEXT: Compiling Wireshark on Windows"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.hljin.net/en-us/2014/09/cross-compile-arm-natvie-gcc/ data-tooltip="Cross-Compiling an ARM Native GCC" aria-label="PREVIOUS: Cross-Compiling an ARM Native GCC"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#gitalk aria-label="Leave a comment"><i class="fa fa-comment"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div><div id=gitalk><noscript>Please enable JavaScript to view the comments powered by Gitalk.</noscript></div><script src=https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js integrity="sha512-EcTCcXV46teiNwe0VcnM5A038tcY+BaQYO4nW6Gh2i7v4/HjBVg7xx3+JBLl9WofDds//INJAiEGAtdgr8PWyA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script type=text/javascript>(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("gitalk").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}new Gitalk({clientID:"2d9c9d837f8496107211",clientSecret:"5a474517d0eb6d5abdb90ab9a31c2ba94f4f43b2",repo:"core2duoe6420.github.io",owner:"core2duoe6420",admin:["core2duoe6420"],id:"ec247d842537e8f626d73331a85ce1a4",...{distractionfreemode:!1,enablehotkey:!0,language:"zh-CN",pagerdirection:"first",perpage:10}}).render("gitalk")})()</script></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2025 Powered by Hugo with tranquilpeak. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.hljin.net/en-us/2014/10/compile-wireshark/ data-tooltip="Compiling Wireshark on Windows" aria-label="NEXT: Compiling Wireshark on Windows"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=https://blog.hljin.net/en-us/2014/09/cross-compile-arm-natvie-gcc/ data-tooltip="Cross-Compiling an ARM Native GCC" aria-label="PREVIOUS: Cross-Compiling an ARM Native GCC"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#gitalk aria-label="Leave a comment"><i class="fa fa-comment"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-times"></i></div><img id=about-card-picture src=https://res.cloudinary.com/core2duoe6420/image/upload/v1643906248/DSC_5117_wviusa.jpg alt="Author's picture"><h4 id=about-card-name>Alex King</h4><div id=about-card-bio>Observing without evaluating is the highest form of human intelligence</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Human</div><div id=about-card-location><i class="fa fa-map-marker-alt"></i><br>Shanghai</div></div></div><div id=cover style=background-image:url(https://res.cloudinary.com/core2duoe6420/image/upload/v1643905455/20220204002352_yqvhwd.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://blog.hljin.net/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-gE8KAQyFIzV1C9+GZ8TKJHZS2s+n7EjNtC+IMRn1l5+WYJTHOODUM6JSjZhFhqXmc7bG8Av6XXpckA4tYhflnw==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/apache.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-EWROca+bote+7Oaaar1F6y74iZj1r1F9rm/ly7o+/FwJopbBaWtsFDmaKoZDd3QiGU2pGacBirHJNivmGLYrow==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/go.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-GDVzAn0wpx1yVtQsRWmFc6PhJiLBPdUic+h4GWgljBh904O3JU10fk9EKNpVyIoPqkFn54rgL2QBG4BmUTMpiQ==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/http.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-UgZlma8NzkrDb/NWgmLIcTrH7i/CSnLLDRFqCSNF5NGPpjKmzyM25qcoXGOup8+cDakKyaiTDd7N4dyH4YT+IA==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/less.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-lot9koe73sfXIrUvIPM/UEhuMciN56RPyBdOyZgfO53P2lkWyyXN7J+njcxIIBRV+nVDQeiWtiXg+bLAJZDTfg==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/nginx.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-Zd3e7XxHP00TD0Imr0PIfeM0fl0v95kMWuhyAS3Wn1UTSXTkz0OhtRgBAr4JlmADRgiXr4x7lpeUdqaGN8xIog==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/puppet.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-qtqDO052iXMSP+5d/aE/jMtL9vIIGvONgTJziC2K/ZIB1yEGa55WVxGE9/08rSQ62EoDifS9SWVGZ7ihSLhzMA==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/scss.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-1NmkjnEDnwwwcu28KoQF8vs3oaPFokQHbmbtwGhFfeDsQZtVFI8zW2aE9O8yMYdpdyKV/5blE4pSWw4Z/Sv97w==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/stylus.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-B2wSfruPjr8EJL6IIzQr1eAuDwrsfIfccNf/LCEdxELCgC/S/ZMt/Uvk80aD79m7IqOqW+Sw8nbkvha20yZpzg==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/swift.min.js></script>
<script async crossorigin=anonymous defer integrity="sha512-28oDiQZGKUVN6wQ7PSLPNipOcmkCALXKwOi7bnkyFf8QiMZQxG9EQoy/iiNx6Zxj2cG2SbVa4dXKigQhu7GiFw==" src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/yaml.min.js></script>
<script async crossorigin=anonymous defer src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
<script>$(document).ready(function(){hljs.configure({classPrefix:"",useBR:!1}),$("pre.code-highlight > code, pre > code").each(function(e,t){$(this).hasClass("codeblock")||$(this).addClass("codeblock"),hljs.highlightBlock(t)})})</script></body></html>